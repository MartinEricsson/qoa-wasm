<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QOA Decoder Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: #2c2c2c;
    }
    .container {
      background: white;
      border-radius: 2px;
      padding: 60px 50px;
      max-width: 700px;
      width: 100%;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    h1 {
      color: #2c2c2c;
      margin-bottom: 8px;
      font-size: 24px;
      font-weight: 400;
      letter-spacing: 0.5px;
    }
    .subtitle {
      color: #787878;
      margin-bottom: 40px;
      font-size: 13px;
      font-weight: 300;
      letter-spacing: 0.3px;
    }
    .drop-zone {
      border: 1px solid #d8d8d8;
      border-radius: 1px;
      padding: 50px 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #fafafa;
    }
    .drop-zone:hover {
      border-color: #2c2c2c;
      background: #f8f8f8;
    }
    .drop-zone.active {
      border-color: #2c2c2c;
      background: #f0f0f0;
    }
    .drop-zone-icon {
      display: none;
    }
    .drop-zone-text {
      color: #787878;
      font-size: 14px;
      font-weight: 300;
      letter-spacing: 0.3px;
    }
    .drop-zone-text strong {
      color: #2c2c2c;
      font-weight: 400;
    }
    #fileInput {
      display: none;
    }
    .player {
      display: none;
      margin-top: 40px;
      padding: 0;
      background: transparent;
      border-radius: 0;
    }
    .player.active {
      display: block;
    }
    .player-info {
      margin-bottom: 30px;
      border-top: 1px solid #e8e8e8;
      padding-top: 20px;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      margin: 0;
      padding: 12px 0;
      background: transparent;
      border-radius: 0;
      border-bottom: 1px solid #f5f5f5;
    }
    .info-row:last-child {
      border-bottom: none;
    }
    .info-label {
      font-weight: 300;
      color: #787878;
      font-size: 13px;
      letter-spacing: 0.3px;
    }
    .info-value {
      color: #2c2c2c;
      font-size: 13px;
      font-weight: 400;
    }
    .controls {
      display: flex;
      gap: 8px;
      justify-content: center;
      align-items: center;
    }
    button {
      background: #2c2c2c;
      color: white;
      border: none;
      padding: 11px 20px;
      border-radius: 1px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 400;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0;
    }
    button:hover {
      background: #1a1a1a;
      transform: none;
      box-shadow: none;
    }
    button:active {
      background: #0a0a0a;
    }
    button:disabled {
      background: #d8d8d8;
      color: #a0a0a0;
      cursor: not-allowed;
      transform: none;
    }
    .progress-bar {
      width: 100%;
      height: 2px;
      background: #e8e8e8;
      border-radius: 0;
      margin: 20px 0;
      overflow: hidden;
      cursor: pointer;
    }
    .progress-fill {
      height: 100%;
      background: #2c2c2c;
      border-radius: 0;
      width: 0%;
      transition: width 0.1s ease;
    }
    .time-display {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #787878;
      margin-bottom: 20px;
      font-weight: 300;
      letter-spacing: 0.3px;
    }
    .status {
      text-align: center;
      margin-top: 20px;
      padding: 12px;
      border-radius: 1px;
      font-size: 13px;
      font-weight: 300;
      letter-spacing: 0.3px;
    }
    .status.loading {
      background: #f5f5f5;
      color: #2c2c2c;
      border: 1px solid #e8e8e8;
    }
    .status.success {
      background: #f5f5f5;
      color: #2c2c2c;
      border: 1px solid #e8e8e8;
    }
    .status.error {
      background: #fafafa;
      color: #2c2c2c;
      border: 1px solid #d8d8d8;
    }
    .waveform {
      width: 100%;
      height: 100px;
      background: #fafafa;
      border-radius: 0;
      margin: 25px 0;
      position: relative;
      overflow: hidden;
      border: 1px solid #e8e8e8;
    }
    .waveform canvas {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>QOA Decoder</h1>
    <div class="subtitle">Decode and play Quite OK Audio files</div>
    
    <div class="drop-zone" id="dropZone">
      <div class="drop-zone-text">
        <strong>Drop a .qoa file here</strong><br>
        or click to browse
      </div>
      <input type="file" id="fileInput" accept=".qoa">
    </div>
    
    <div class="player" id="player">
      <div class="player-info">
        <div class="info-row">
          <span class="info-label">File:</span>
          <span class="info-value" id="fileName">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">Channels:</span>
          <span class="info-value" id="channels">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">Sample Rate:</span>
          <span class="info-value" id="sampleRate">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">Duration:</span>
          <span class="info-value" id="duration">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">Samples:</span>
          <span class="info-value" id="samples">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">Decode time:</span>
          <span class="info-value" id="decodeTime">-</span>
        </div>
      </div>

      <div class="waveform" id="waveform">
        <canvas id="waveformCanvas"></canvas>
      </div>
      
      <div class="time-display">
        <span id="currentTime">0:00</span>
        <span id="totalTime">0:00</span>
      </div>
      
      <div class="progress-bar" id="progressBar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      
      <div class="controls">
        <button id="playBtn">Play</button>
        <button id="pauseBtn" style="display: none;">Pause</button>
        <button id="stopBtn">Stop</button>
        <button id="loadNewBtn">Load New</button>
      </div>
    </div>
    
    <div class="status" id="status" style="display: none;"></div>
  </div>

  <script src="src/qoa-decoder.js"></script>
  <script>
    let audioContext = null;
    let audioBuffer = null;
    let audioSource = null;
    let startTime = 0;
    let pauseTime = 0;
    let isPlaying = false;
    let animationFrame = null;
    
    // DEBUG: Expose variables to window for debugging
    window.getDebugInfo = () => ({
      hasDecoder: QOADecoder?.isInitialized?.() ?? false,
      hasAudioUtils: !!window.QOAUtils,
      hasAudioContext: !!audioContext,
      hasAudioBuffer: !!audioBuffer,
      audioBufferDuration: audioBuffer?.duration,
      audioBufferChannels: audioBuffer?.numberOfChannels
    });

    async function ensureDecodeHelper() {
      if (window.QOAUtils?.decodeToAudioBuffer) {
        return window.QOAUtils.decodeToAudioBuffer;
      }

      await new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'src/utils/decode-to-audio-buffer.js';
        script.async = false;
        script.onload = resolve;
        script.onerror = () => reject(new Error('Failed to load decode-to-audio-buffer.js'));
        document.head.appendChild(script);
      });

      const helper = window.QOAUtils?.decodeToAudioBuffer;
      if (typeof helper !== 'function') {
        throw new Error('decodeToAudioBuffer helper not available after loading script.');
      }
      return helper;
    }

    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const player = document.getElementById('player');
    const status = document.getElementById('status');

    // Initialize decoder
    async function init() {
      try {
        showStatus('Initializing decoder...', 'loading');
        await QOADecoder.init();
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        hideStatus();
      } catch (error) {
        showStatus(`Failed to initialize: ${error.message}`, 'error');
      }
    }

    // File handling
    dropZone.addEventListener('click', () => fileInput.click());
    
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('active');
    });
    
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('active');
    });
    
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('active');
      const file = e.dataTransfer.files[0];
      if (file) handleFile(file);
    });
    
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) handleFile(file);
    });

    async function handleFile(file) {
      console.log('handleFile called with:', file.name);
      if (!file.name.endsWith('.qoa')) {
        showStatus('Please select a .qoa file', 'error');
        return;
      }

      try {
        showStatus('Decoding audio...', 'loading');
        
    const arrayBuffer = await file.arrayBuffer();
    console.log('ArrayBuffer loaded, size:', arrayBuffer.byteLength);

  const t0 = performance.now();
  const decoded = QOADecoder.decode(arrayBuffer);
  const t1 = performance.now();
  const decodeMs = t1 - t0;
        const decodeToAudioBuffer = await ensureDecodeHelper();
        audioBuffer = decodeToAudioBuffer(decoded, audioContext);
        console.log('Audio decoded successfully', audioBuffer);
        
        // Update UI
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('channels').textContent = audioBuffer.numberOfChannels;
        document.getElementById('sampleRate').textContent = `${audioBuffer.sampleRate} Hz`;
        document.getElementById('duration').textContent = formatTime(audioBuffer.duration);
        document.getElementById('totalTime').textContent = formatTime(audioBuffer.duration);
        document.getElementById('samples').textContent = audioBuffer.length.toLocaleString();
  document.getElementById('decodeTime').textContent = `${decodeMs.toFixed(1)} ms`;
        
        window.beforePlayerShow = Date.now();
        
        // Show player first so canvas has proper dimensions
        player.classList.add('active');
        console.log('Player shown, calling drawWaveform...');
        
        window.afterPlayerShow = Date.now();
        
        // Draw waveform - call directly since player is now visible
        try {
          window.beforeDrawWaveform = Date.now();
          drawWaveform(audioBuffer);
          window.afterDrawWaveform = Date.now();
          console.log('drawWaveform completed successfully');
        } catch (waveformError) {
          console.error('Error in drawWaveform:', waveformError);
          window.waveformError = waveformError.message;
        }
        
        window.beforeShowStatus = Date.now();
        
        showStatus('Ready to play!', 'success');
        setTimeout(hideStatus, 2000);
      } catch (error) {
        console.error('Error in handleFile:', error);
        showStatus(`Error decoding file: ${error.message}`, 'error');
      }
    }

    // Playback controls
    document.getElementById('playBtn').addEventListener('click', () => {
      console.log('Play button clicked!', { hasAudioBuffer: !!audioBuffer });
      if (!audioBuffer) return;
      
      try {
        console.log('Starting playback...');
        audioSource = audioContext.createBufferSource();
        audioSource.buffer = audioBuffer;
        audioSource.connect(audioContext.destination);
        
        if (pauseTime > 0) {
          audioSource.start(0, pauseTime);
          startTime = audioContext.currentTime - pauseTime;
        } else {
          audioSource.start(0);
          startTime = audioContext.currentTime;
        }
        
        audioSource.onended = () => {
          if (isPlaying) {
            stopPlayback();
          }
        };
        
        isPlaying = true;
        console.log('Changing button visibility...');
        document.getElementById('playBtn').style.display = 'none';
        document.getElementById('pauseBtn').style.display = 'flex';
        console.log('Calling updateProgress...');
        updateProgress();
        console.log('Playback started successfully!');
      } catch (error) {
        console.error('Error during playback:', error);
      }
    });

    document.getElementById('pauseBtn').addEventListener('click', () => {
      if (!audioSource) return;
      
      pauseTime = audioContext.currentTime - startTime;
      audioSource.stop();
      audioSource = null;
      isPlaying = false;
      
      document.getElementById('pauseBtn').style.display = 'none';
      document.getElementById('playBtn').style.display = 'flex';
      
      if (animationFrame) {
        cancelAnimationFrame(animationFrame);
      }
    });

    document.getElementById('stopBtn').addEventListener('click', stopPlayback);

    document.getElementById('loadNewBtn').addEventListener('click', () => {
      stopPlayback();
      player.classList.remove('active');
      fileInput.value = '';
      audioBuffer = null;
    });

    function stopPlayback() {
      if (audioSource) {
        audioSource.stop();
        audioSource = null;
      }
      isPlaying = false;
      pauseTime = 0;
      startTime = 0;
      
      document.getElementById('pauseBtn').style.display = 'none';
      document.getElementById('playBtn').style.display = 'flex';
      document.getElementById('currentTime').textContent = '0:00';
      document.getElementById('progressFill').style.width = '0%';
      
      if (animationFrame) {
        cancelAnimationFrame(animationFrame);
      }
    }

    function updateProgress() {
      if (!isPlaying || !audioBuffer) return;
      
      const currentTime = audioContext.currentTime - startTime;
      const duration = audioBuffer.duration;
      
      if (currentTime >= duration) {
        stopPlayback();
        return;
      }
      
      const progress = (currentTime / duration) * 100;
      document.getElementById('progressFill').style.width = `${progress}%`;
      document.getElementById('currentTime').textContent = formatTime(currentTime);
      
      animationFrame = requestAnimationFrame(updateProgress);
    }

    // Progress bar seeking
    document.getElementById('progressBar').addEventListener('click', (e) => {
      if (!audioBuffer) return;
      
      const rect = e.target.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const percentage = x / rect.width;
      const newTime = percentage * audioBuffer.duration;
      
      if (isPlaying) {
        document.getElementById('pauseBtn').click();
        pauseTime = newTime;
        document.getElementById('playBtn').click();
      } else {
        pauseTime = newTime;
        const progress = (newTime / audioBuffer.duration) * 100;
        document.getElementById('progressFill').style.width = `${progress}%`;
        document.getElementById('currentTime').textContent = formatTime(newTime);
      }
    });

    function drawWaveform(buffer) {
      window.drawWaveformCalled = (window.drawWaveformCalled || 0) + 1;
      window.drawWaveformCallTime = Date.now();
      
      console.log('drawWaveform called', { buffer, hasBuffer: !!buffer });
      const canvas = document.getElementById('waveformCanvas');
      const ctx = canvas.getContext('2d');
      const parent = canvas.parentElement;
      
      console.log('Parent dimensions:', { 
        clientWidth: parent.clientWidth, 
        clientHeight: parent.clientHeight,
        offsetWidth: parent.offsetWidth,
        offsetHeight: parent.offsetHeight 
      });
      
      // Set canvas size
      canvas.width = parent.clientWidth;
      canvas.height = parent.clientHeight;
      
      console.log('Canvas dimensions set to:', { width: canvas.width, height: canvas.height });
      
      if (canvas.width === 0 || canvas.height === 0) {
        console.error('Canvas has zero dimensions!');
        return;
      }
      
      const data = buffer.getChannelData(0);
      const step = Math.ceil(data.length / canvas.width);
      const amp = canvas.height / 2;
      
      ctx.fillStyle = '#fafafa';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      ctx.beginPath();
      ctx.strokeStyle = '#2c2c2c';
      ctx.lineWidth = 1;
      
      for (let i = 0; i < canvas.width; i++) {
        let min = 1.0;
        let max = -1.0;
        
        for (let j = 0; j < step; j++) {
          const datum = data[(i * step) + j];
          if (datum < min) min = datum;
          if (datum > max) max = datum;
        }
        
        ctx.moveTo(i, (1 + min) * amp);
        ctx.lineTo(i, (1 + max) * amp);
      }
      
      ctx.stroke();
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function showStatus(message, type) {
      status.textContent = message;
      status.className = `status ${type}`;
      status.style.display = 'block';
    }

    function hideStatus() {
      status.style.display = 'none';
    }

    // Initialize on load
    init();
  </script>
</body>
</html>
