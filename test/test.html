<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QOA Decoder Tests</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1000px;
      margin: 40px auto;
      padding: 0 20px;
      line-height: 1.6;
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #4CAF50;
      padding-bottom: 10px;
    }
    .test-section {
      margin: 20px 0;
      padding: 20px;
      background: #f5f5f5;
      border-radius: 8px;
    }
    .test-result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      border-left: 4px solid #ccc;
    }
    .test-result.pass {
      background: #d4edda;
      border-left-color: #28a745;
      color: #155724;
    }
    .test-result.fail {
      background: #f8d7da;
      border-left-color: #dc3545;
      color: #721c24;
    }
    .test-result.running {
      background: #fff3cd;
      border-left-color: #ffc107;
      color: #856404;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .test-details {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      margin-top: 5px;
      padding: 5px;
      background: rgba(0,0,0,0.05);
      border-radius: 4px;
    }
    .summary {
      font-size: 20px;
      font-weight: bold;
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h1>QOA Decoder Test Suite</h1>
  
  <div class="summary" id="summary">
    <div>Tests: <span id="totalTests">0</span></div>
    <div>Passed: <span id="passedTests">0</span></div>
    <div>Failed: <span id="failedTests">0</span></div>
  </div>

  <div class="test-section">
    <h2>Test Controls</h2>
    <button onclick="runAllTests()">Run All Tests</button>
    <button onclick="clearResults()">Clear Results</button>
  </div>

  <div class="test-section">
    <h2>Test Results</h2>
    <div id="test-results"></div>
  </div>

  <script src="../src/qoa-decoder.js"></script>
  <script>
    let testResults = [];

    async function initDecoder() {
      await QOADecoder.init();
      return QOADecoder;
    }

    async function ensureDecodeHelper() {
      if (window.QOAUtils?.decodeToAudioBuffer) {
        return window.QOAUtils.decodeToAudioBuffer;
      }

      await new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = '../src/utils/decode-to-audio-buffer.js';
        script.async = false;
        script.onload = resolve;
        script.onerror = () => reject(new Error('Failed to load decode-to-audio-buffer.js for tests.'));
        document.head.appendChild(script);
      });

      const helper = window.QOAUtils?.decodeToAudioBuffer;
      if (typeof helper !== 'function') {
        throw new Error('decodeToAudioBuffer helper not available after loading script');
      }
      return helper;
    }

    function addTestResult(name, passed, details = '') {
      testResults.push({ name, passed, details });
      updateDisplay();
    }

    function updateDisplay() {
      const resultsDiv = document.getElementById('test-results');
      resultsDiv.innerHTML = '';

      testResults.forEach(result => {
        const div = document.createElement('div');
        div.className = `test-result ${result.passed ? 'pass' : 'fail'}`;
        div.innerHTML = `
          <strong>${result.name}</strong>: ${result.passed ? '✓ PASS' : '✗ FAIL'}
          ${result.details ? `<div class="test-details">${result.details}</div>` : ''}
        `;
        resultsDiv.appendChild(div);
      });

      // Update summary
      const total = testResults.length;
      const passed = testResults.filter(r => r.passed).length;
      const failed = total - passed;

      document.getElementById('totalTests').textContent = total;
      document.getElementById('passedTests').textContent = passed;
      document.getElementById('failedTests').textContent = failed;
    }

    function clearResults() {
      testResults = [];
      updateDisplay();
    }

    async function testDecoderInitialization() {
      try {
        await initDecoder();
        const passed = QOADecoder.isInitialized();
        addTestResult('Decoder Initialization', passed, 
          passed ? 'Decoder initialized successfully' : 'Failed to initialize decoder');
      } catch (error) {
        addTestResult('Decoder Initialization', false, `Error: ${error.message}`);
      }
    }

    async function testLoadSampleFile() {
      try {
        await initDecoder();
        const response = await fetch('test/test_5120samples.qoa');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const buffer = await response.arrayBuffer();
        const passed = buffer.byteLength > 0;
        addTestResult('Load Sample File', passed, 
          `Loaded ${buffer.byteLength} bytes from test_5120samples.qoa`);
        return buffer;
      } catch (error) {
        addTestResult('Load Sample File', false, `Error: ${error.message}`);
        return null;
      }
    }

    async function testDecodeBasic() {
      try {
        await initDecoder();
        const buffer = await loadTestFile('test/test_5120samples.qoa');
        if (!buffer) {
          addTestResult('Basic Decode', false, 'Failed to load test file');
          return null;
        }

        const decoded = QOADecoder.decode(buffer);
        const passed = decoded && decoded.samples && decoded.samples.length > 0;
        addTestResult('Basic Decode', passed, 
          passed ? `Decoded ${decoded.samplesPerChannel} samples, ${decoded.channels} channels, ${decoded.sampleRate} Hz` 
                : 'Decoding failed');
        return decoded;
      } catch (error) {
        addTestResult('Basic Decode', false, `Error: ${error.message}`);
        return null;
      }
    }

    async function testDecodeMetadata() {
      try {
        await initDecoder();
        const buffer = await loadTestFile('test/test_5120samples.qoa');
        if (!buffer) {
          addTestResult('Metadata Validation', false, 'Failed to load test file');
          return;
        }

        const decoded = QOADecoder.decode(buffer);
        
        // Check expected values for the test sample
        const correctChannels = decoded.channels === 1; // mono
        const correctSampleRate = decoded.sampleRate === 22050;
        const correctSampleCount = decoded.samplesPerChannel === 5120;
        const hasSamples = decoded.samplesPerChannel > 0;
        const hasCorrectLength = decoded.samples.length === decoded.samplesPerChannel * decoded.channels;

        const passed = correctChannels && correctSampleRate && correctSampleCount && hasSamples && hasCorrectLength;
        addTestResult('Metadata Validation', passed, 
          `Channels: ${decoded.channels} (expected 1), Sample Rate: ${decoded.sampleRate} (expected 22050), ` +
          `Samples: ${decoded.samplesPerChannel} (expected 5120), Total length: ${decoded.samples.length}`);
      } catch (error) {
        addTestResult('Metadata Validation', false, `Error: ${error.message}`);
      }
    }

    async function testSampleValues() {
      try {
        await initDecoder();
        const buffer = await loadTestFile('test/test_5120samples.qoa');
        if (!buffer) {
          addTestResult('Sample Value Range', false, 'Failed to load test file');
          return;
        }

        const decoded = QOADecoder.decode(buffer);
        
        // Check that samples are in valid 16-bit range
        let min = 32767;
        let max = -32768;
        let allValid = true;
        
        for (let i = 0; i < decoded.samples.length; i++) {
          const sample = decoded.samples[i];
          if (sample < -32768 || sample > 32767) {
            allValid = false;
            break;
          }
          min = Math.min(min, sample);
          max = Math.max(max, sample);
        }

        const passed = allValid && min >= -32768 && max <= 32767;
        addTestResult('Sample Value Range', passed, 
          `Sample range: [${min}, ${max}], All samples in valid range: ${allValid}`);
      } catch (error) {
        addTestResult('Sample Value Range', false, `Error: ${error.message}`);
      }
    }

    async function testDecodeToAudioBuffer() {
      try {
        await initDecoder();
        const buffer = await loadTestFile('test/test_5120samples.qoa');
        if (!buffer) {
          addTestResult('AudioBuffer Conversion', false, 'Failed to load test file');
          return;
        }

        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const decoded = QOADecoder.decode(buffer);
        const decodeToAudioBuffer = await ensureDecodeHelper();
        const audioBuffer = decodeToAudioBuffer(decoded, audioContext);
        
        const passed = audioBuffer && 
                      audioBuffer.numberOfChannels > 0 && 
                      audioBuffer.length > 0 &&
                      audioBuffer.sampleRate > 0;
        
        addTestResult('AudioBuffer Conversion', passed, 
          passed ? `Created AudioBuffer: ${audioBuffer.numberOfChannels} channels, ${audioBuffer.length} samples, ${audioBuffer.sampleRate} Hz`
                : 'Failed to create AudioBuffer');
      } catch (error) {
        addTestResult('AudioBuffer Conversion', false, `Error: ${error.message}`);
      }
    }

    async function testInvalidInput() {
      // NOTE: The decoder no longer performs validation of input data.
      // It assumes valid QOA streams are provided by the host.
      // These tests are disabled as validation is now the caller's responsibility.
      
      addTestResult('Invalid Input Tests', true, 
        'Skipped - decoder no longer validates input (assumes valid QOA data)');
      
      /* Original tests disabled:
      try {
        await initDecoder();
        
        // Test with empty buffer
        try {
          const empty = new ArrayBuffer(0);
          QOADecoder.decode(empty);
          addTestResult('Invalid Input (Empty)', false, 'Should have thrown error for empty buffer');
        } catch (e) {
          addTestResult('Invalid Input (Empty)', true, 'Correctly rejected empty buffer');
        }

        // Test with too small buffer
        try {
          const tooSmall = new ArrayBuffer(8);
          QOADecoder.decode(tooSmall);
          addTestResult('Invalid Input (Too Small)', false, 'Should have thrown error for too small buffer');
        } catch (e) {
          addTestResult('Invalid Input (Too Small)', true, 'Correctly rejected too small buffer');
        }

        // Test with invalid magic number
        try {
          const invalid = new ArrayBuffer(16);
          const view = new DataView(invalid);
          view.setUint32(0, 0x12345678); // Wrong magic
          QOADecoder.decode(invalid);
          addTestResult('Invalid Input (Wrong Magic)', false, 'Should have thrown error for wrong magic number');
        } catch (e) {
          addTestResult('Invalid Input (Wrong Magic)', true, 'Correctly rejected wrong magic number');
        }

      } catch (error) {
        addTestResult('Invalid Input Tests', false, `Unexpected error: ${error.message}`);
      }
      */
    }

    async function loadTestFile(url) {
      try {
        const response = await fetch(url);
        if (!response.ok) return null;
        return await response.arrayBuffer();
      } catch (error) {
        console.error('Error loading test file:', error);
        return null;
      }
    }

    async function runAllTests() {
      clearResults();
      
      // Add a "running" indicator
      const resultsDiv = document.getElementById('test-results');
      resultsDiv.innerHTML = '<div class="test-result running">Running tests...</div>';
      
      await testDecoderInitialization();
      await testLoadSampleFile();
      await testDecodeBasic();
      await testDecodeMetadata();
      await testSampleValues();
      await testDecodeToAudioBuffer();
      await testInvalidInput();
    }

    // Auto-run tests on page load
    window.addEventListener('load', () => {
      console.log('Page loaded, ready to run tests');
    });
  </script>
</body>
</html>
